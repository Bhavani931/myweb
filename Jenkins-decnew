pipeline {
    agent any

    tools {
        maven 'Maven_3.9.6'   // Adjust to your Maven installation name in Jenkins
        jdk 'JDK17'           // Adjust to your JDK installation name in Jenkins
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Bhavani931/myweb.git'
            }
        }

        stage('Read & Update POM') {
            steps {
                script {
                    def pom = readMavenPom file: 'pom.xml'
                    echo "GroupId: ${pom.groupId}"
                    echo "ArtifactId: ${pom.artifactId}"
                    echo "Version: ${pom.version}"

                    def newVersion = "${pom.version}.${env.BUILD_NUMBER}"
                    echo "Updating version to ${newVersion}"

                    // Read POM as plain text
                    def pomText = readFile('pom.xml')

                    // Replace first occurrence of <version>...</version>
                    pomText = pomText.replaceFirst("<version>${pom.version}</version>", "<version>${newVersion}</version>")

                    // Write updated POM back
                    writeFile file: 'pom.xml', text: pomText
                }
            }
        }

        stage('Run Tests') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Build WAR') {
            steps {
                sh 'mvn clean package'
            }
        }

        stage('Deploy to Nexus') {
            steps {
                sh 'mvn deploy'
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                sshagent(['my-ec2-ssh-key']) {
                    sh '''
                    scp -o StrictHostKeyChecking=no target/myweb-*.war ec2-user@3.115.15.25:/opt/tomcat/webapps/
                    '''
                }
            }
        }

        stage('Restart Tomcat') {
            steps {
                sshagent(['my-ec2-ssh-key']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no ec2-user@3.115.15.25 "sudo systemctl restart tomcat"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Build, Nexus upload, and Tomcat deployment completed successfully!"
        }
        failure {
            echo "❌ Pipeline failed. Please check logs."
        }
    }
}
