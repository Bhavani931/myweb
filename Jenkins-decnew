pipeline {
    agent any

    tools {
        maven 'Maven_3.9.6'   // Adjust to your Maven installation name in Jenkins
        jdk 'JDK17'           // Adjust to your JDK installation name in Jenkins
    }

    stages {
        stage('Checkout') {
            steps {
                // Pull code from GitHub
                git branch: 'main', url: 'https://github.com/Bhavani931/myweb.git'
            }
        }

        stage('Read & Update POM') {
            steps {
                script {
                    // Read Maven POM
                    def pom = readMavenPom file: 'pom.xml'
                    echo "GroupId: ${pom.groupId}"
                    echo "ArtifactId: ${pom.artifactId}"
                    echo "Version: ${pom.version}"

                    // New version based on Jenkins build number
                    def newVersion = "${pom.version}.${env.BUILD_NUMBER}"
                    echo "Updating version to ${newVersion}"

                    // Parse XML and update <version>
                    def pomFile = new XmlSlurper().parse(new File("pom.xml"))
                    pomFile.version.replaceBody(newVersion)

                    // Save updated POM back to file
                    def writer = new FileWriter("pom.xml")
                    new groovy.xml.XmlNodePrinter(new PrintWriter(writer)).print(pomFile)
                }
            }
        }

        stage('Run Tests') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Build WAR') {
            steps {
                sh 'mvn clean package'
            }
        }

        stage('Deploy to Nexus') {
            steps {
                sh 'mvn deploy'
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                // Use Jenkins SSH credentials to connect to EC2/Tomcat
                sshagent(['my-ec2-ssh-key']) {
                    sh '''
                    scp -o StrictHostKeyChecking=no target/myweb-*.war ec2-user@3.115.15.25:/opt/tomcat/webapps/
                    '''
                }
            }
        }

        stage('Restart Tomcat') {
            steps {
                sshagent(['my-ec2-ssh-key']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no ec2-user@3.115.15.25 "sudo systemctl restart tomcat"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Build, Nexus upload, and Tomcat deployment completed successfully!"
        }
        failure {
            echo "❌ Pipeline failed. Please check logs."
        }
    }
}
